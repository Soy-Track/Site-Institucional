<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="imagex/png" href="img/Logo-SoyTrack/iconeSoyTrackVERDE.png">
    <link rel="stylesheet" href="css/login_cadastro.css">
    <title> SoyTrack</title>
</head>

<body  onload ="listar(), listaremail()">
    <!-- essa parte é a do lado esquerdo, mas a estilização é a mesma do lado direito do login -->
    <div class="lado_direito_cadastro">
        <div class="lado_direito-itens">
            <h2 class="logo">Crie sua conta!</h2>
            <p>Junte-se a nós para ter um controle preciso do nível de grãos dos seus silos.
                <br><b>O cadastro é rápido e fácil!</b>
            </p>
            <img src="img/Logo-SoyTrack/logoTipoSoyTrackBRANCA.png" alt="" id="logo-login">
        </div>
    </div>

    <!-- essa parte é a do lado direito, mas a estilização é a mesma do lado esquerdo do login -->
    <div class="lado_esquerdo">
        <h1>Cadastro</h1>
        <label>Nome:</label>
        <input id="ipt_nomeCadastro" class="input_cadastro_login" placeholder="Digite seu nome completo">
        <label>E-mail:</label>
        <input oninput="email()"id="ipt_emailCadastro" class="input_cadastro_login" placeholder="Digite seu E-mail" type="email">
        <label>Senha:</label>
        <input oninput="senha()"  id="ipt_senhaCadastro" class="input_cadastro_login" placeholder="Crie uma senha forte" type="password">
        <div id="txt" class="link_login_esqueci_senha"></div>
        <label>Confirme sua senha:</label>
        <input id="ipt_confirSenha" class="input_cadastro_login" placeholder="Confirme sua senha" type="password">
        <label>Token:</label>
        <input id="ipt_tokenCadastro" class="input_cadastro_login" placeholder="Digite o token de sua empresa">
        <button onclick="cadastrar()" class="input_cadastro_login">Cadastrar</button>
        <div id="id_link_login_esqueci_senha">
            <p>Já tem conta? <a href="login.html"> Faça login</a></p>
        </div>
    </div>
    

</body>

</html>

<script>
     let listaEmpresasCadastradas = [];
  let listaemail = [];

  function cadastrar() {

    var nomeVar = ipt_nomeCadastro.value
    var emailVar = ipt_emailCadastro.value
    var senhaVar = ipt_senhaCadastro.value
    var confirma_senhaVar = ipt_confirSenha.value
    var tokenVar = ipt_tokenCadastro.value
    var tokenvalido = false;
    var email_em_uso = false;

    for (let i = 0; i < listaemail.length; i++) {
      if (listaemail[i].email == emailVar) {
        console.log("email já em uso");
        email_em_uso = true;
        break;
      }
    }
      for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
      if (listaEmpresasCadastradas[i].idtoken == tokenVar) {
        var idEmpresaVincular = listaEmpresasCadastradas[i].fkempresa
        console.log("Código de ativação válido.");
        tokenvalido = true;
        break;
      }
    }

    if (nomeVar == "") {
      alert("Por favor, preencha o campo nome.");
    } else if (emailVar == "") {
      alert("Por favor, preencha o campo do email.");
    } else if (emailVar.includes('@') == false || emailVar.includes('.') == false) {
      alert('E-mail inválido!' + '\n' + 'Por favor digite um e-mail válido')
    } else if (senhaVar == "") {
      alert("Por favor, preencha o campo de senha.");
    } else if (confirma_senhaVar == "") {
      alert("Por favor, preencha o campo de confirmação de senha.");
    } else if (tokenVar == "") {
      alert("Por favor, preencha o campo do token.");
    } else if (senhaVar != confirma_senhaVar) {
      alert('Senha inválida. Verifique a senha criada e sua confirmação para prosseguir!')
    } else if (tokenvalido == false) {
      alert('token invalido por favor verifique');
    } else if (email_em_uso == true) {
      alert('email já está sendo usado por favor tente um novo email')
    } else {
      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          // crie um atributo que recebe o valor recuperado aqui
          // Agora vá para o arquivo routes/usuario.js
          nomeServer: nomeVar,
          emailServer: emailVar,
          senhaServer: senhaVar,
          empresaServer: idEmpresaVincular,

        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta);
          if (resposta.ok) {
            alert('Cadastro enviado para a analise');
            window.location = "login.html";
            ipt_nomeCadastro.value = ""
            ipt_emailCadastro.value = ""
            ipt_senhaCadastro.value = ""
            ipt_confirSenha.value = ""
            ipt_tokenCadastro.value = ""
          } else {
            alert("Houve um erro ao tentar realizar o cadastro!");
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
        });
    }
  }

  function senha() {
    var senha = ipt_senhaCadastro.value
    if ((senha.includes('1') || senha.includes('2') || senha.includes('3') || senha.includes('4') || senha.includes('5') ||
      senha.includes('6') || senha.includes('7') || senha.includes('8') || senha.includes('9') || senha.includes('0')) &&
      (senha.includes('!') || senha.includes('@') || senha.includes('#') || senha.includes('$') || senha.includes('%') ||
        senha.includes('¨') || senha.includes('&') || senha.includes('*')) && (senha.length >= 6)) {
      txt.innerHTML = `<span style="color: darkgreen;">Senha forte</span>`
    } else {
      txt.innerHTML = `<span style="color: red;">Senha fraca (precisa ter pelo menos um caracter especial, um número e 6 caracteres no mínimo)</span>`
    }
  }

  function listar() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);

            console.log("listaEmpresasCadastradas")
            console.log(listaEmpresasCadastradas[0].idtoken)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
    fetch('')
  }

  function listaremail() {
    fetch("/empresas/listaremail", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((email) => {
            listaemail.push(email);

            console.log("listaEmpresasCadastradas")
            console.log(listaemail[0].email)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
    fetch('')
  }
</script>